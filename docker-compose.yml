services:
  firestore-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud emulators firestore start --host-port=0.0.0.0:8080 --project=demo-project
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  wiremock:
    image: wiremock/wiremock:3.4.2
    ports:
      - "8081:8080"
    volumes:
      - ./fixtures/mocks:/home/wiremock/mappings
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/__admin/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # Phase 3 — .NET Indexing API
  # Start with: docker compose --profile phase3 up -d
  indexing-api:
    profiles: ["phase3"]
    build:
      context: ../grohe-neo-services
      dockerfile: src/GroheNeo.IndexingApi/Dockerfile
    ports:
      - "8082:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Integration
      ASPNETCORE_URLS: http://+:8080
      FIRESTORE_EMULATOR_HOST: firestore-emulator:8080
      GCLOUD_PROJECT: demo-project
    depends_on:
      firestore-emulator:
        condition: service_healthy
      wiremock:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 18
      start_period: 60s

  # Phase 4 — .NET NavigationApi (no Chrome — build ~2–3 min first time)
  # Start with: make infra-phase4-up  (seeds configuration collection first)
  navigation-api:
    profiles: ["phase4"]
    build:
      context: ../grohe-neo-services
      dockerfile: src/GroheNeo.ProductsDynamicNavigationApi/Dockerfile
    ports:
      - "8083:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Integration
      ASPNETCORE_URLS: http://+:8080
      FIRESTORE_EMULATOR_HOST: firestore-emulator:8080
      GCLOUD_PROJECT: demo-project
      configuration_project_id: demo-project
      configuration_table: (default)
      Neo_XMCloudApi_BaseUrl: http://wiremock:8080
    depends_on:
      firestore-emulator:
        condition: service_healthy
      wiremock:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 18
      start_period: 60s

  # Phase 5 — .NET SearchApi (no Firestore — build ~2-3 min first time)
  # Start with: docker compose --profile phase5 up -d
  search-api:
    profiles: ["phase5"]
    build:
      context: ../grohe-neo-services
      dockerfile: src/GroheNeo.SearchApi/Dockerfile
    ports:
      - "8085:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Integration
      ASPNETCORE_URLS: http://+:8080
    depends_on:
      wiremock:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 18
      start_period: 60s

  # Phase 4 — .NET ProductsApi (installs Chrome — first build ~15–20 min)
  products-api:
    profiles: ["phase4"]
    build:
      context: ../grohe-neo-services
      dockerfile: src/GroheNeo.ProductsApi/Dockerfile
    ports:
      - "8084:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Integration
      ASPNETCORE_URLS: http://+:8080
      FIRESTORE_EMULATOR_HOST: firestore-emulator:8080
      GCLOUD_PROJECT: demo-project
      configuration_project_id: demo-project
      configuration_table: (default)
      NeoXMCloudApiBaseUrl: http://wiremock:8080
    depends_on:
      firestore-emulator:
        condition: service_healthy
      wiremock:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 10s
      retries: 24
      start_period: 120s
